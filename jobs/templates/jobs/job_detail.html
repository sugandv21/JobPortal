{% extends 'jobs/base.html' %}
{% block title %}{{ job.title }} - {{ job.company }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="card-title">{{ job.title }}</h2>
        <h6 class="card-subtitle text-muted mb-2">
          {{ job.company }}{% if job.location %} • {{ job.location }}{% endif %}
        </h6>

        <p class="text-muted mb-2"><small>Posted {{ job.created_at|date:"M d, Y" }}</small></p>

        <hr>

        <div class="mb-3">
          {{ job.description|linebreaks }}
        </div>

        <div class="d-flex gap-2">
          {# Apply button: visible to authenticated non-poster users #}
          {% if user.is_authenticated and job.poster != user %}
            {% if not has_applied %}
              <a class="btn btn-success" href="{% url 'jobs:job_apply' job.pk %}">Apply</a>
            {% else %}
              <span class="btn btn-outline-secondary disabled">Already applied</span>
            {% endif %}
          {% elif not user.is_authenticated %}
            <a class="btn btn-primary" href="{% url 'login' %}?next={% url 'jobs:job_detail' job.pk %}">Login to apply</a>
          {% endif %}

          {# Edit/Delete: only visible to the poster #}
          {% if user.is_authenticated and job.poster == user %}
            <a class="btn btn-outline-primary" href="{% url 'jobs:job_update' job.pk %}">Edit</a>

            <form method="post" action="{% url 'jobs:job_delete' job.pk %}" style="display:inline;">
              {% csrf_token %}
              <button class="btn btn-outline-danger" onclick="return confirm('Delete this job?');">Delete</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    {# Applications list (visible to poster and staff) #}
    <div class="card">
      <div class="card-body">
        <h5 class="mb-3">Applications <span class="badge bg-secondary">{{ applications.count }}</span></h5>

        {% if applications %}
          <ul class="list-group">
            {% for app in applications %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ app.applicant.username }}{% if app.applicant.email %} <small class="text-muted">&lt;{{ app.applicant.email }}&gt;</small>{% endif %}</div>
                  <small class="text-muted">Applied {{ app.applied_at|date:"M d, Y H:i" }}</small>
                  <div class="mt-2">{{ app.cover_letter|linebreaksbr }}</div>
                </div>

                <div class="text-end">
                  <div class="mb-2">
                    <span class="badge 
                      {% if app.status == 'applied' %}bg-info
                      {% elif app.status == 'review' %}bg-warning
                      {% elif app.status == 'accepted' %}bg-success
                      {% elif app.status == 'rejected' %}bg-danger
                      {% elif app.status == 'withdrawn' %}bg-secondary
                      {% endif %}
                    ">{{ app.get_status_display }}</span>
                  </div>

                  {# Resume link: only the job poster or staff see the resume/download link #}
                  {% if user.is_authenticated %}
                    {% if user == job.poster or user.is_staff %}
                      {% if app.resume %}
                        <div class="mb-2">
                          <a class="btn btn-sm btn-outline-secondary" href="{{ app.resume.url }}" target="_blank" rel="noopener">Download Resume</a>
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endif %}

                  {# If this application belongs to the logged-in user and not withdrawn, show Withdraw button #}
                  {% if user.is_authenticated and app.applicant == user and app.status != 'withdrawn' %}
                    <form method="post" action="{% url 'jobs:withdraw_application' app.pk %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Withdraw your application?');">Withdraw</button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="alert alert-info mb-0">No applications yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <aside class="col-lg-4">
    <div class="card mb-3">
      <div class="card-body">
        <h6>Job Details</h6>
        <dl class="row">
          <dt class="col-5">Company</dt><dd class="col-7">{{ job.company }}</dd>
          <dt class="col-5">Location</dt><dd class="col-7">{{ job.location|default:"—" }}</dd>
          <dt class="col-5">Posted by</dt><dd class="col-7">{{ job.poster.username }}</dd>
        </dl>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h6>Helpful</h6>
        <p class="small text-muted mb-0">If you are applying, make sure your resume is up-to-date and in PDF/DOC/DOCX format. Resumes are stored in the media directory — ensure `MEDIA_URL` / `MEDIA_ROOT` are configured and served in development.</p>
      </div>
    </div>
  </aside>
</div>
{% endblock %}
