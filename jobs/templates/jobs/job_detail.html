{% extends 'jobs/base.html' %}
{% block title %}{{ job.title }} – {{ job.company }} · JobPortal{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <!-- Header -->
    <div class="d-flex align-items-start justify-content-between mb-3">
      <div>
        <h1 class="h3 mb-1">{{ job.title }}</h1>
        <div class="text-muted">
          <span class="me-2">{{ job.company }}</span>
          {% if job.location %}• <span class="ms-2">{{ job.location }}</span>{% endif %}
        </div>
        <div class="small text-muted mt-1">Posted {{ job.created_at|date:"M d, Y" }}</div>
      </div>

      <!-- Action area -->
      <div class="ms-3 text-end">
        {% if user.is_authenticated %}
          {% if user == job.poster %}
            <a href="{% url 'jobs:job_update' job.pk %}" class="btn btn-outline-secondary btn-sm">Edit</a>
            <a href="{% url 'jobs:job_delete' job.pk %}" class="btn btn-outline-danger btn-sm"
               onclick="return confirm('Delete this job?');">Delete</a>
          {% else %}
            {% if user.profile.is_employer %}
              {# Employers cannot apply #}
            {% else %}
              {% if has_applied %}
                <span class="badge bg-success">Applied</span>
              {% else %}
                <a href="{% url 'jobs:job_apply' job.pk %}" class="btn btn-primary btn-sm">Apply</a>
              {% endif %}
            {% endif %}
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}?next={{ request.path|urlencode }}" class="btn btn-primary btn-sm">Login to apply</a>
        {% endif %}
      </div>
    </div>

    <!-- Description -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Job Description</h5>
        <p class="mb-0" style="white-space:pre-line">{{ job.description }}</p>
      </div>
    </div>

    <!-- Applicant view: your application + interviews -->
    {% if user.is_authenticated and not user.profile.is_employer and my_app %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Your application</h5>
            <span class="badge bg-secondary">{{ my_app.get_status_display }}</span>
          </div>
          <div class="mt-2">
            <div>Submitted on {{ my_app.applied_at|date:"M d, Y h:i A" }}</div>
            <div class="small mt-1">
              <a href="{{ my_app.resume.url }}" target="_blank">View resume ({{ my_app.get_resume_filename }})</a>
            </div>
          </div>

          {% if my_app.status != 'withdrawn' %}
            <form class="mt-2" method="post" action="{% url 'jobs:withdraw_application' my_app.pk %}">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-sm" onclick="return confirm('Withdraw your application?');">
                Withdraw application
              </button>
            </form>
          {% else %}
            <div class="mt-2 small text-danger">You withdrew this application.</div>
          {% endif %}

          {% if my_app.interviews.all %}
            <hr>
            <h6 class="mb-2">Your interviews</h6>
            {% for iv in my_app.interviews.all %}
              <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                <div class="small">
                  {{ iv.scheduled_at|date:"M d, Y h:i A" }} • {{ iv.get_mode_display }}
                  {% if iv.location %} • {{ iv.location }}{% endif %}
                  {% if iv.meet_link %} • <a href="{{ iv.meet_link }}" target="_blank">Join link</a>{% endif %}
                  • <span class="badge bg-light text-dark">{{ iv.status }}</span>
                  {% if iv.invite_sent %}<span class="badge bg-success">notified</span>{% endif %}
                </div>
              </div>
            {% empty %}
              <div class="small text-muted">No interviews scheduled yet.</div>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    {% endif %}

    <!-- Employer panel: applications + shortlist + interview scheduling -->
    {% if user.is_authenticated and user == job.poster %}
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Applications ({{ job.applications.count }})</h5>

          {% for app in job.applications.all %}
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ app.applicant.username }}</strong>
                  <span class="badge bg-secondary ms-1">{{ app.get_status_display }}</span>
                  <div class="small mt-1">
                    <a href="{{ app.resume.url }}" target="_blank">Resume: {{ app.get_resume_filename }}</a>
                  </div>
                  {% if app.cover_letter %}
                    <details class="mt-1">
                      <summary class="small text-muted">Cover letter</summary>
                      <div class="small mt-1" style="white-space:pre-line">{{ app.cover_letter }}</div>
                    </details>
                  {% endif %}
                  <div class="small text-muted mt-1">Applied {{ app.applied_at|date:"M d, Y h:i A" }}</div>
                </div>

                <div class="d-flex gap-2">
                  <!-- Shortlist -->
                  <form method="post" action="{% url 'jobs:application_shortlist' app.pk %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-success"
                            {% if app.status == 'shortlisted' %}disabled{% endif %}>
                      Shortlist
                    </button>
                  </form>

                  <!-- Schedule Interview -->
                  <a class="btn btn-sm btn-primary" href="{% url 'jobs:interview_create' app.pk %}">
                    Schedule Interview
                  </a>
                </div>
              </div>

              <!-- Interviews for this application -->
              {% if app.interviews.all %}
                <div class="mt-2">
                  <div class="small text-muted mb-1">Interviews</div>
                  {% for iv in app.interviews.all %}
                    <div class="d-flex align-items-center justify-content-between py-1">
                      <div class="small">
                        {{ iv.scheduled_at|date:"M d, Y h:i A" }} • {{ iv.get_mode_display }}
                        {% if iv.location %} • {{ iv.location }}{% endif %}
                        {% if iv.meet_link %} • <a href="{{ iv.meet_link }}" target="_blank">link</a>{% endif %}
                        • <span class="badge bg-light text-dark">{{ iv.status }}</span>
                        {% if iv.invite_sent %}<span class="badge bg-success">notified</span>{% endif %}
                      </div>
                      <div class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-secondary"
                           href="{% url 'jobs:interview_update' iv.pk %}">Edit</a>
                        <form method="post" action="{% url 'jobs:interview_cancel' iv.pk %}">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger"
                                  {% if iv.status == 'canceled' %}disabled{% endif %}>
                            Cancel
                          </button>
                        </form>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-muted">No applications yet.</div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h6 class="text-muted mb-2">Job info</h6>
        <div class="small">
          <div><strong>Company:</strong> {{ job.company }}</div>
          {% if job.location %}<div><strong>Location:</strong> {{ job.location }}</div>{% endif %}
          <div><strong>Posted:</strong> {{ job.created_at|date:"M d, Y" }}</div>
          <div><strong>Updated:</strong> {{ job.updated_at|date:"M d, Y" }}</div>
        </div>
      </div>
    </div>

    {% if user.is_authenticated and user != job.poster and not user.profile.is_employer %}
      <div class="card shadow-sm">
        <div class="card-body">
          {% if has_applied %}
            <div class="alert alert-success mb-2">You have already applied to this job.</div>
            {% if my_app and my_app.status != 'withdrawn' %}
              <form method="post" action="{% url 'jobs:withdraw_application' my_app.pk %}">
                {% csrf_token %}
                <button class="btn btn-outline-danger w-100"
                        onclick="return confirm('Withdraw your application?');">
                  Withdraw application
                </button>
              </form>
            {% endif %}
          {% else %}
            <a href="{% url 'jobs:job_apply' job.pk %}" class="btn btn-primary w-100">Apply Now</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
